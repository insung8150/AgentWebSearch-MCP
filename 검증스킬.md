# 검증 스킬 (Agent-search-v3-CDmcp-v1)

목표: CDP 기반 검색 에이전트의 동작을 검증한다.
중요: **검증은 어시스턴트가 직접 실행**한다. 사용자는 요청만 한다.

## 아키텍처

```
search_agent.py
    ↓
cdp_search.py (싱글톤 MCP 클라이언트)
    ↓
chrome-devtools MCP Server (stdio)
    ↓
Chrome (CDP, port 9222) ← 세션 유지
    ↓
네이버 → 구글 → Brave (순차)
```

## 특징

- **캐시 없음**: 모든 검색/fetch가 매번 새로 실행됨
- **Chrome 세션 싱글톤**: MCP 1회 초기화 후 세션 유지 (봇 감지 회피)
- **순차 검색**: 3개 포털 순차 실행 (MCP 단일 세션 특성)
- **예상 소요 시간**: 검색 ~35초/쿼리, 전체 E2E ~150-180초

## 1) 단일 검증 실행

내부 실행 명령(어시스턴트가 직접 실행):
```bash
cd /home/yooha/JOB_FOLD/LLM_test/Agent-search-v3-CDmcp-v1
source venv/bin/activate
timeout 300 python search_agent.py "테스트 쿼리" 2>&1 | tee /tmp/agent_search_v3_cdmcp_test.txt
```

## 2) 배치 검증 실행

내부 실행 명령(어시스턴트가 직접 실행):
```bash
cd /home/yooha/JOB_FOLD/LLM_test/Agent-search-v3-CDmcp-v1
source venv/bin/activate

queries=(
  "아이폰 17 출시 루머"
  "테슬라 FSD 최신 업데이트"
  "한국 기준금리 전망"
  "AI 반도체 시장 동향 2026"
  "서울 아파트 전세시장 전망"
)

for i in "${!queries[@]}"; do
  q="${queries[$i]}"
  out="/tmp/agent_search_v3_cdmcp_q$((i+1)).txt"
  echo "[$((i+1))/5] $q"
  { time timeout 300 python search_agent.py "$q" > "$out" 2>&1; } 2>> /tmp/agent_search_v3_cdmcp_times.txt
done
```

결과 파일:
- 개별 결과: `/tmp/agent_search_v3_cdmcp_q{1..5}.txt`
- 시간 요약: `/tmp/agent_search_v3_cdmcp_times.txt`

## 3) 결과 요약 (어시스턴트 수행)

내부 요약 로직:
- stderr에서 검색/fetch 시간 추출
- 성공/실패 분류 및 출처 수 집계
- 결과표로 요약 보고

확인 항목:
- `[CDP] MCP 클라이언트 초기화` 메시지 (세션 시작)
- `[검색 완료]` 메시지와 소요 시간
- `[fetch 완료]` 메시지와 건수
- 최종 답변 출력 여부

## 4) 판정 기준

| 상태 | 조건 |
|------|------|
| **ok** | 정상 결과 + 출처 존재 |
| **limited** | 결과는 있으나 일부 검색/fetch 실패 |
| **timeout** | 300초 초과 |
| **search_failure** | CDP 검색 실패 (Chrome 연결 불가 등) |
| **model_error** | SGLang 모델 호출 실패 |

## 5) 테스트 쿼리 (고정)

1. 아이폰 17 출시 루머
2. 테슬라 FSD 최신 업데이트
3. 한국 기준금리 전망
4. AI 반도체 시장 동향 2026
5. 서울 아파트 전세시장 전망

## 6) 사전 요구사항

검증 전 확인:
```bash
# Chrome CDP 포트 확인
curl -s http://localhost:9222/json/version | jq .Browser

# Chrome 시작 (필요 시)
google-chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-cdp-profile &

# 탭 정리 (탭 폭증 시)
cd /home/yooha/JOB_FOLD/LLM_test/Agent-search-v3-CDmcp-v1
source venv/bin/activate
python clear_tabs.py

# SGLang 서버 확인
curl -s http://localhost:30001/v1/models | jq .data[0].id
```

## 7) 예상 결과

| 쿼리 | 검색 시간 | fetch 시간 | 전체 시간 |
|------|----------|-----------|----------|
| 단일 (3포털) | **~20초** | ~20-45초 | ~100-120초 |

**v2 개선사항** (2026-02-18):
- 탭 3개 재사용으로 검색 시간 ~40초 → **~20초** 단축
- 탭 폭증 문제 해결 (CDP 직접 정리)
- 캐시 없음 - 항상 최신 정보 검색
